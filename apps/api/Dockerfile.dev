FROM node:20-alpine

# Install system dependencies: git, openssl, and pnpm
RUN apk add --no-cache git openssl openssl-dev && npm install -g pnpm

WORKDIR /workspace

# Copy workspace root files (when context is root dir)
COPY package.json pnpm-lock.yaml* pnpm-workspace.yaml ./

# Copy package.json files for all workspace packages
COPY apps/api/package.json ./apps/api/
COPY apps/web/package.json ./apps/web/

# Install all workspace dependencies
RUN pnpm install --frozen-lockfile

# Copy prisma schema for client generation
COPY apps/api/prisma ./apps/api/prisma

# Generate Prisma client
WORKDIR /workspace/apps/api
RUN pnpm exec prisma generate

# Copy all API source code
COPY apps/api ./

# Expose ports
EXPOSE 4000 5555

# Copy startup script
COPY apps/api/start-dev.sh ./start-dev.sh
RUN chmod +x ./start-dev.sh

# Start development server with Prisma Studio
CMD ["./start-dev.sh"]
