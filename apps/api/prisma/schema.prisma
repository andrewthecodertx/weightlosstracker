// Prisma schema for Weight Tracker

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users and Authentication
model User {
  id              String    @id @default(uuid())
  email           String    @unique
  username        String    @unique
  passwordHash    String    @map("password_hash")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  emailVerified   Boolean   @default(false) @map("email_verified")
  avatarUrl       String?   @map("avatar_url")
  bio             String?
  privacySettings Json      @default("{\"profile\": \"public\", \"weight\": \"team\", \"posts\": \"public\"}") @map("privacy_settings")
  deletedAt       DateTime? @map("deleted_at")

  profile              UserProfile?
  weightEntries        WeightEntry[]
  teamMemberships      TeamMember[]
  posts                Post[]
  comments             Comment[]
  messages             Message[]
  conversationMembers  ConversationParticipant[]
  challengeParticipants ChallengeParticipant[]
  achievements         UserAchievement[]
  createdTeams         Team[]                    @relation("TeamCreator")
  createdChallenges    Challenge[]               @relation("ChallengeCreator")

  @@map("users")
}

// User Profile with Weight Data
model UserProfile {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  currentWeight   Decimal? @map("current_weight") @db.Decimal(5, 2)
  goalWeight      Decimal? @map("goal_weight") @db.Decimal(5, 2)
  height          Decimal? @db.Decimal(5, 2) // in cm
  activityLevel   String?  @map("activity_level") // sedentary, light, moderate, active, very_active
  dateOfBirth     DateTime? @map("date_of_birth") @db.Date
  gender          String?
  preferredUnits  String   @default("metric") @map("preferred_units") // metric or imperial

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// Weight Entries for Tracking
model WeightEntry {
  id                 String   @id @default(uuid())
  userId             String   @map("user_id")
  weight             Decimal  @db.Decimal(5, 2)
  bodyFatPercentage  Decimal? @map("body_fat_percentage") @db.Decimal(4, 2)
  muscleMass         Decimal? @map("muscle_mass") @db.Decimal(5, 2)
  waterPercentage    Decimal? @map("water_percentage") @db.Decimal(4, 2)
  notes              String?
  photoUrls          String[] @map("photo_urls")
  recordedAt         DateTime @default(now()) @map("recorded_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, recordedAt(sort: Desc)])
  @@map("weight_entries")
}

// Teams for Group Competition
model Team {
  id          String    @id @default(uuid())
  name        String
  description String?
  avatarUrl   String?   @map("avatar_url")
  createdBy   String    @map("created_by")
  isPublic    Boolean   @default(true) @map("is_public")
  joinCode    String    @unique @map("join_code")
  maxMembers  Int       @default(50) @map("max_members")
  settings    Json      @default("{}")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  creator    User          @relation("TeamCreator", fields: [createdBy], references: [id])
  members    TeamMember[]
  posts      Post[]
  challenges Challenge[]
  conversation Conversation?

  @@map("teams")
}

// Team Memberships
model TeamMember {
  id              String   @id @default(uuid())
  teamId          String   @map("team_id")
  userId          String   @map("user_id")
  role            String   @default("member") // admin, moderator, member
  joinedAt        DateTime @default(now()) @map("joined_at")
  weightLossGoal  Decimal? @map("weight_loss_goal") @db.Decimal(5, 2)
  startingWeight  Decimal? @map("starting_weight") @db.Decimal(5, 2)

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@map("team_members")
}

// Posts (Public and Team)
model Post {
  id             String    @id @default(uuid())
  authorId       String    @map("author_id")
  teamId         String?   @map("team_id")
  title          String?
  content        String
  postType       String    @default("update") @map("post_type") // update, milestone, tip, question, recipe, workout
  visibility     String    @default("public") // public, team, private
  mediaUrls      String[]  @map("media_urls")
  tags           String[]
  likesCount     Int       @default(0) @map("likes_count")
  commentsCount  Int       @default(0) @map("comments_count")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at")

  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  team     Team?     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  comments Comment[]

  @@index([visibility, createdAt(sort: Desc)])
  @@index([teamId, createdAt(sort: Desc)])
  @@index([authorId, createdAt(sort: Desc)])
  @@map("posts")
}

// Comments on Posts
model Comment {
  id        String    @id @default(uuid())
  postId    String    @map("post_id")
  authorId  String    @map("author_id")
  parentId  String?   @map("parent_id")
  content   String
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  post     Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")

  @@index([postId, createdAt])
  @@index([postId, parentId, createdAt])
  @@map("comments")
}

// Messaging System
model Conversation {
  id            String   @id @default(uuid())
  isGroup       Boolean  @default(false) @map("is_group")
  teamId        String?  @unique @map("team_id")
  name          String?
  createdAt     DateTime @default(now()) @map("created_at")
  lastMessageAt DateTime @default(now()) @map("last_message_at")

  team         Team?                      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  id                   String    @id @default(uuid())
  conversationId       String    @map("conversation_id")
  userId               String    @map("user_id")
  lastReadAt           DateTime? @map("last_read_at")
  notificationsEnabled Boolean   @default(true) @map("notifications_enabled")
  joinedAt             DateTime  @default(now()) @map("joined_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id             String    @id @default(uuid())
  conversationId String    @map("conversation_id")
  senderId       String    @map("sender_id")
  content        String
  messageType    String    @default("text") @map("message_type") // text, image, weight_update, achievement
  metadata       Json?
  editedAt       DateTime? @map("edited_at")
  deletedAt      DateTime? @map("deleted_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt(sort: Desc)])
  @@index([senderId, createdAt(sort: Desc)])
  @@map("messages")
}

// Challenges and Competitions
model Challenge {
  id            String   @id @default(uuid())
  teamId        String?  @map("team_id")
  name          String
  description   String?
  challengeType String   @map("challenge_type") // weight_loss_percentage, total_weight, consistency, activity
  startDate     DateTime @map("start_date")
  endDate       DateTime @map("end_date")
  targetValue   Decimal? @map("target_value") @db.Decimal(10, 2)
  rewardPoints  Int      @default(0) @map("reward_points")
  createdBy     String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")

  team         Team?                   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  creator      User                    @relation("ChallengeCreator", fields: [createdBy], references: [id])
  participants ChallengeParticipant[]

  @@index([teamId, startDate, endDate])
  @@map("challenges")
}

// Challenge Participation
model ChallengeParticipant {
  id            String   @id @default(uuid())
  challengeId   String   @map("challenge_id")
  userId        String   @map("user_id")
  startingValue Decimal? @map("starting_value") @db.Decimal(10, 2)
  currentValue  Decimal? @map("current_value") @db.Decimal(10, 2)
  targetValue   Decimal? @map("target_value") @db.Decimal(10, 2)
  completed     Boolean  @default(false)
  joinedAt      DateTime @default(now()) @map("joined_at")

  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userId])
  @@map("challenge_participants")
}

// Achievements/Badges System
model Achievement {
  id            String  @id @default(uuid())
  name          String  @unique
  description   String?
  iconUrl       String? @map("icon_url")
  points        Int     @default(0)
  criteriaType  String  @map("criteria_type") // weight_loss, consistency, social, challenge_completion
  criteriaValue Json    @map("criteria_value")

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  achievementId String   @map("achievement_id")
  earnedAt      DateTime @default(now()) @map("earned_at")

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id])

  @@unique([userId, achievementId])
  @@map("user_achievements")
}
